<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>compound-eye</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d1117;
      --bg-card: #161b22;
      --bg-input: #0d1117;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #7d8590;
      --text-dim: #484f58;
      --accent: #58a6ff;
      --disposition-open: #7d8590;
      --disposition-addressed: #3fb950;
      --disposition-wont_fix: #484f58;
      --disposition-deferred: #d29922;
      --font-mono: "SF Mono", "Cascadia Code", "Fira Code", "JetBrains Mono", monospace;
    }

    body {
      font-family: var(--font-mono);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 16px 80px;
    }

    header {
      margin-bottom: 24px;
    }

    header h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    /* Capture form */
    #capture-form {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    #capture-form input {
      font-family: var(--font-mono);
      font-size: 14px;
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s;
    }

    #capture-form input:focus {
      border-color: var(--accent);
    }

    #capture-form input::placeholder {
      color: var(--text-dim);
    }

    #capture-text {
      flex: 3;
    }

    #capture-project {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 14px;
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      outline: none;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    #capture-project:focus {
      border-color: var(--accent);
    }

    #capture-form button[type="submit"] {
      font-family: var(--font-mono);
      font-size: 14px;
      padding: 8px 16px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }

    #capture-form button[type="submit"]:hover {
      opacity: 0.9;
    }

    #capture-flash {
      font-size: 12px;
      color: var(--disposition-addressed);
      opacity: 0;
      transition: opacity 0.2s;
      margin-bottom: 8px;
      height: 18px;
    }

    #capture-flash.visible {
      opacity: 1;
    }

    /* Filters */
    #filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
    }

    #filters select, #filters input {
      font-family: var(--font-mono);
      font-size: 12px;
      padding: 6px 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      outline: none;
    }

    #filters select {
      cursor: pointer;
    }

    #filters input::placeholder {
      color: var(--text-dim);
    }

    #filters select:focus, #filters input:focus {
      border-color: var(--accent);
    }

    /* Observation list */
    #observation-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .observation {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }

    .observation:hover {
      border-color: var(--text-dim);
    }

    .obs-checkbox {
      margin-top: 3px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .obs-disposition {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      user-select: none;
      transition: opacity 0.15s;
      flex-shrink: 0;
      margin-top: 1px;
      position: relative;
    }

    .obs-disposition:hover {
      opacity: 0.8;
    }

    .obs-disposition[data-disposition="open"] {
      background: var(--disposition-open);
      color: #fff;
    }

    .obs-disposition[data-disposition="addressed"] {
      background: var(--disposition-addressed);
      color: #000;
    }

    .obs-disposition[data-disposition="wont_fix"] {
      background: var(--disposition-wont_fix);
      color: #999;
    }

    .obs-disposition[data-disposition="deferred"] {
      background: var(--disposition-deferred);
      color: #000;
    }

    /* Disposition picker */
    .disposition-picker {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 0;
      z-index: 10;
      min-width: 120px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .disposition-picker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      font-size: 11px;
      font-family: var(--font-mono);
      cursor: pointer;
      color: var(--text);
      white-space: nowrap;
    }

    .disposition-picker-option:hover {
      background: var(--border);
    }

    .disposition-picker-option .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .obs-body {
      flex: 1;
      min-width: 0;
    }

    .obs-text {
      margin-bottom: 4px;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .obs-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .obs-source {
      display: inline-block;
      padding: 1px 6px;
      background: var(--bg);
      border: 1px solid var(--disposition-deferred);
      border-radius: 4px;
      font-size: 11px;
      color: var(--disposition-deferred);
    }

    .obs-project {
      color: var(--accent);
    }

    .obs-time {
      color: var(--text-dim);
    }

    .obs-actions-toggle {
      color: var(--text-dim);
      cursor: pointer;
      font-size: 11px;
      font-family: var(--font-mono);
      background: none;
      border: none;
      padding: 0;
    }

    .obs-actions-toggle:hover {
      color: var(--text-muted);
    }

    /* Action log */
    .obs-action-log {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    .action-item {
      font-size: 11px;
      padding: 4px 0;
      color: var(--text-muted);
    }

    .action-item + .action-item {
      border-top: 1px solid var(--border);
    }

    .action-description {
      color: var(--text);
      margin-bottom: 2px;
    }

    .action-meta {
      display: flex;
      gap: 8px;
      font-size: 10px;
      color: var(--text-dim);
    }

    .action-reference a {
      color: var(--accent);
      text-decoration: none;
    }

    .action-reference a:hover {
      text-decoration: underline;
    }

    .action-empty {
      font-size: 11px;
      color: var(--text-dim);
      font-style: italic;
    }

    .obs-delete {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 14px;
      padding: 0 4px;
      margin-top: 1px;
      flex-shrink: 0;
    }

    .obs-delete:hover {
      color: #f85149;
    }

    /* Empty state */
    #empty-state {
      text-align: center;
      padding: 48px 16px;
      color: var(--text-dim);
      font-size: 13px;
    }

    /* Manage projects */
    #manage-projects {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    #manage-projects summary {
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px 12px;
      user-select: none;
    }

    #manage-projects-inner {
      padding: 8px 12px 12px;
    }

    #scan-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    #scan-path {
      font-family: var(--font-mono);
      font-size: 12px;
      padding: 6px 10px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      outline: none;
      flex: 1;
    }

    #scan-path:focus {
      border-color: var(--accent);
    }

    #scan-path::placeholder {
      color: var(--text-dim);
    }

    .manage-btn {
      font-family: var(--font-mono);
      font-size: 12px;
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
    }

    .manage-btn:hover {
      border-color: var(--accent);
    }

    #scan-candidates label {
      display: block;
      font-size: 12px;
      padding: 4px 0;
      color: var(--text);
      cursor: pointer;
    }

    #scan-candidates input[type="checkbox"] {
      accent-color: var(--accent);
      margin-right: 6px;
    }

    .project-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 12px;
    }

    .project-delete {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 14px;
      padding: 0 4px;
    }

    .project-delete:hover {
      color: #f85149;
    }

    #scan-status {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Action bar */
    #action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: none;
      justify-content: center;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }

    #action-bar.visible {
      display: flex;
    }

    #action-bar button {
      font-family: var(--font-mono);
      font-size: 13px;
      padding: 6px 16px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    #action-bar button:hover {
      opacity: 0.9;
    }

    #action-bar .count {
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>compound-eye</h1>
    </header>

    <form id="capture-form">
      <input id="capture-text" type="text" placeholder="what did you observe?" autofocus />
      <select id="capture-project" required>
        <option value="" disabled selected>project</option>
      </select>
      <button type="submit">capture</button>
    </form>
    <div id="capture-flash"></div>

    <div id="filters">
      <select id="filter-disposition">
        <option value="">all dispositions</option>
        <option value="open">open</option>
        <option value="addressed">addressed</option>
        <option value="wont_fix">won't fix</option>
        <option value="deferred">deferred</option>
      </select>
      <select id="filter-source">
        <option value="">all sources</option>
        <option value="human">human</option>
        <option value="agent">agent</option>
      </select>
      <select id="filter-project">
        <option value="">all projects</option>
      </select>
    </div>

    <details id="manage-projects">
      <summary>manage projects</summary>
      <div id="manage-projects-inner">
        <div id="scan-row">
          <input id="scan-path" type="text" placeholder="path to scan for git repos (e.g. ~/code)" />
          <button id="scan-btn" class="manage-btn">scan</button>
        </div>
        <div id="scan-results" style="display: none;">
          <div id="scan-candidates"></div>
          <div style="margin-top: 8px; display: flex; gap: 8px;">
            <button id="register-selected-btn" class="manage-btn">register selected</button>
            <button id="select-all-btn" class="manage-btn">select all</button>
          </div>
        </div>
        <div id="scan-status"></div>
        <div id="project-list-section">
          <div style="font-size: 12px; color: var(--text-muted); margin: 12px 0 8px;">registered projects</div>
          <div id="project-list"></div>
        </div>
      </div>
    </details>

    <div id="observation-list"></div>
    <div id="empty-state" style="display: none;">No observations yet. Start typing above.</div>
  </div>

  <div id="action-bar">
    <span class="count"><span id="selected-count">0</span> selected</span>
    <button id="copy-btn">Copy for Claude</button>
  </div>

  <script>
    (function () {
      const DISPOSITIONS = [
        { value: "open", label: "open", color: "#7d8590" },
        { value: "addressed", label: "addressed", color: "#3fb950" },
        { value: "wont_fix", label: "won't fix", color: "#484f58" },
        { value: "deferred", label: "deferred", color: "#d29922" },
      ];

      const DISPOSITION_LABELS = {};
      for (const d of DISPOSITIONS) DISPOSITION_LABELS[d.value] = d.label;

      let observations = [];
      let projects = [];
      let selectedIds = new Set();
      let openPicker = null;  // track open disposition picker
      let expandedActions = new Set();  // track expanded action logs
      let actionCache = {};  // cache fetched actions by observation id

      const captureForm = document.getElementById("capture-form");
      const captureText = document.getElementById("capture-text");
      const captureProject = document.getElementById("capture-project");
      const captureFlash = document.getElementById("capture-flash");
      const filterDisposition = document.getElementById("filter-disposition");
      const filterSource = document.getElementById("filter-source");
      const filterProject = document.getElementById("filter-project");
      const observationList = document.getElementById("observation-list");
      const emptyState = document.getElementById("empty-state");
      const actionBar = document.getElementById("action-bar");
      const selectedCount = document.getElementById("selected-count");
      const copyBtn = document.getElementById("copy-btn");

      function esc(str) {
        const el = document.createElement("span");
        el.textContent = str;
        return el.innerHTML;
      }

      function relativeTime(iso) {
        const now = Date.now();
        const then = new Date(iso.endsWith("Z") ? iso : iso + "Z").getTime();
        const diff = now - then;
        const mins = Math.floor(diff / 60000);
        if (mins < 1) return "just now";
        if (mins < 60) return mins + "m ago";
        const hours = Math.floor(mins / 60);
        if (hours < 24) return hours + "h ago";
        const days = Math.floor(hours / 24);
        if (days < 30) return days + "d ago";
        return iso.slice(0, 10);
      }

      function buildFilterParams() {
        const params = new URLSearchParams();
        if (filterDisposition.value) params.set("disposition", filterDisposition.value);
        if (filterSource.value) params.set("source", filterSource.value);
        if (filterProject.value) params.set("project", filterProject.value);
        return params.toString();
      }

      async function fetchObservations() {
        const query = buildFilterParams();
        const url = "/api/observations" + (query ? "?" + query : "");
        try {
          const res = await fetch(url);
          observations = await res.json();
        } catch (err) {
          console.error("Failed to fetch observations:", err);
          observations = [];
        }
        render();
      }

      function render() {
        // Clean up selectedIds — remove any that are no longer in the list
        const currentIds = new Set(observations.map(o => o.id));
        for (const id of selectedIds) {
          if (!currentIds.has(id)) selectedIds.delete(id);
        }

        if (observations.length === 0) {
          observationList.innerHTML = "";
          emptyState.style.display = "block";
        } else {
          emptyState.style.display = "none";
          observationList.innerHTML = observations.map(renderCard).join("");
        }

        updateActionBar();
      }

      function renderCard(obs) {
        const checked = selectedIds.has(obs.id) ? "checked" : "";
        const dispositionLabel = DISPOSITION_LABELS[obs.disposition] || obs.disposition;

        const sourceHtml = obs.source && obs.source !== "human"
          ? '<span class="obs-source">' + esc(obs.source) + "</span>"
          : "";
        const projectHtml = obs.project
          ? '<span class="obs-project">' + esc(obs.project) + "</span>"
          : "";

        const actionsExpanded = expandedActions.has(obs.id);
        const actionsToggleLabel = actionsExpanded ? "hide actions" : "actions";

        let actionLogHtml = "";
        if (actionsExpanded) {
          const cached = actionCache[obs.id];
          if (cached) {
            if (cached.length === 0) {
              actionLogHtml = '<div class="obs-action-log"><div class="action-empty">no actions yet</div></div>';
            } else {
              actionLogHtml = '<div class="obs-action-log">' +
                cached.map(renderActionItem).join("") +
              '</div>';
            }
          } else {
            actionLogHtml = '<div class="obs-action-log"><div class="action-empty">loading...</div></div>';
          }
        }

        return '<div class="observation">' +
          '<input type="checkbox" class="obs-checkbox" data-id="' + obs.id + '" ' + checked + ' />' +
          '<span class="obs-disposition" data-disposition="' + esc(obs.disposition) + '" data-id="' + obs.id + '">' + esc(dispositionLabel) + "</span>" +
          '<div class="obs-body">' +
            '<div class="obs-text">' + esc(obs.text) + "</div>" +
            '<div class="obs-meta">' +
              sourceHtml +
              projectHtml +
              '<span class="obs-time">' + relativeTime(obs.created_at) + "</span>" +
              '<button class="obs-actions-toggle" data-id="' + obs.id + '">' + actionsToggleLabel + '</button>' +
            "</div>" +
            actionLogHtml +
          "</div>" +
          '<button class="obs-delete" data-id="' + obs.id + '" title="delete">\u00d7</button>' +
        "</div>";
      }

      function renderActionItem(action) {
        let refHtml = "";
        if (action.reference) {
          const isUrl = action.reference.startsWith("http://") || action.reference.startsWith("https://");
          refHtml = isUrl
            ? '<span class="action-reference"><a href="' + esc(action.reference) + '" target="_blank" rel="noopener">' + esc(action.reference) + '</a></span>'
            : '<span class="action-reference">' + esc(action.reference) + '</span>';
        }

        return '<div class="action-item">' +
          '<div class="action-description">' + esc(action.description) + '</div>' +
          '<div class="action-meta">' +
            '<span>' + esc(action.source) + '</span>' +
            (action.project ? '<span>' + esc(action.project) + '</span>' : '') +
            refHtml +
            '<span>' + relativeTime(action.created_at) + '</span>' +
          '</div>' +
        '</div>';
      }

      function updateActionBar() {
        selectedCount.textContent = selectedIds.size;
        if (selectedIds.size > 0) {
          actionBar.classList.add("visible");
        } else {
          actionBar.classList.remove("visible");
        }
      }

      function flash(msg) {
        captureFlash.textContent = msg;
        captureFlash.classList.add("visible");
        setTimeout(() => captureFlash.classList.remove("visible"), 1500);
      }

      function closePicker() {
        if (openPicker) {
          openPicker.remove();
          openPicker = null;
        }
      }

      function showDispositionPicker(badgeEl, obsId, currentDisposition) {
        closePicker();

        const picker = document.createElement("div");
        picker.className = "disposition-picker";

        for (const d of DISPOSITIONS) {
          const option = document.createElement("div");
          option.className = "disposition-picker-option";
          if (d.value === currentDisposition) {
            option.style.fontWeight = "700";
          }
          option.innerHTML = '<span class="dot" style="background: ' + d.color + '"></span>' + esc(d.label);
          option.addEventListener("click", async (e) => {
            e.stopPropagation();
            closePicker();
            if (d.value === currentDisposition) return;

            try {
              await fetch("/api/observations/" + obsId, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ disposition: d.value }),
              });
              await fetchObservations();
            } catch (err) {
              console.error("Failed to update disposition:", err);
            }
          });
          picker.appendChild(option);
        }

        badgeEl.style.position = "relative";
        badgeEl.appendChild(picker);
        openPicker = picker;
      }

      // Close picker on outside click
      document.addEventListener("click", (e) => {
        if (openPicker && !e.target.closest(".obs-disposition")) {
          closePicker();
        }
      });

      // Capture form
      captureForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = captureText.value.trim();
        if (!text) return;

        const project = captureProject.value || null;

        const body = { text };
        if (project) body.project = project;

        try {
          const res = await fetch("/api/observations", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          if (res.ok) {
            captureText.value = "";
            captureText.focus();
            flash("captured");
            await fetchObservations();
          }
        } catch (err) {
          console.error("Failed to create observation:", err);
        }
      });

      // Disposition click — show picker
      observationList.addEventListener("click", async (e) => {
        const dispositionEl = e.target.closest(".obs-disposition");
        if (dispositionEl && !e.target.closest(".disposition-picker")) {
          e.stopPropagation();
          const id = parseInt(dispositionEl.dataset.id, 10);
          const current = dispositionEl.dataset.disposition;
          showDispositionPicker(dispositionEl, id, current);
          return;
        }

        // Actions toggle
        const actionsToggle = e.target.closest(".obs-actions-toggle");
        if (actionsToggle) {
          const id = parseInt(actionsToggle.dataset.id, 10);
          if (expandedActions.has(id)) {
            expandedActions.delete(id);
            render();
          } else {
            expandedActions.add(id);
            render();
            // Fetch actions if not cached
            if (!actionCache[id]) {
              try {
                const res = await fetch("/api/observations/" + id + "/actions");
                actionCache[id] = await res.json();
                render();
              } catch (err) {
                console.error("Failed to fetch actions:", err);
              }
            }
          }
          return;
        }

        // Delete click
        const deleteEl = e.target.closest(".obs-delete");
        if (deleteEl) {
          const id = parseInt(deleteEl.dataset.id, 10);
          try {
            await fetch("/api/observations/" + id, { method: "DELETE" });
            selectedIds.delete(id);
            await fetchObservations();
          } catch (err) {
            console.error("Failed to delete:", err);
          }
          return;
        }
      });

      // Checkbox changes
      observationList.addEventListener("change", (e) => {
        if (e.target.classList.contains("obs-checkbox")) {
          const id = parseInt(e.target.dataset.id, 10);
          if (e.target.checked) {
            selectedIds.add(id);
          } else {
            selectedIds.delete(id);
          }
          updateActionBar();
        }
      });

      // Copy for Claude
      copyBtn.addEventListener("click", async () => {
        if (selectedIds.size === 0) return;

        try {
          const res = await fetch("/api/observations/export", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids: Array.from(selectedIds) }),
          });

          if (res.ok) {
            const data = await res.json();
            await navigator.clipboard.writeText(data.markdown);
            copyBtn.textContent = "Copied!";
            setTimeout(() => { copyBtn.textContent = "Copy for Claude"; }, 1500);
          }
        } catch (err) {
          console.error("Failed to export:", err);
        }
      });

      // Filters
      filterDisposition.addEventListener("change", fetchObservations);
      filterSource.addEventListener("change", fetchObservations);
      filterProject.addEventListener("change", fetchObservations);

      // --- Project management ---

      const scanBtn = document.getElementById("scan-btn");
      const scanPathInput = document.getElementById("scan-path");
      const scanResults = document.getElementById("scan-results");
      const scanCandidates = document.getElementById("scan-candidates");
      const scanStatus = document.getElementById("scan-status");
      const registerSelectedBtn = document.getElementById("register-selected-btn");
      const selectAllBtn = document.getElementById("select-all-btn");
      const projectListEl = document.getElementById("project-list");

      async function fetchProjects() {
        try {
          const res = await fetch("/api/projects");
          projects = await res.json();
        } catch (err) {
          console.error("Failed to fetch projects:", err);
          projects = [];
        }
        populateProjectSelects();
        renderProjectList();
      }

      function populateProjectSelects() {
        const currentCapture = captureProject.value;
        captureProject.innerHTML = '<option value="" disabled>project</option>';
        for (const p of projects) {
          const opt = document.createElement("option");
          opt.value = p.name;
          opt.textContent = p.name;
          captureProject.appendChild(opt);
        }
        if (currentCapture && projects.some(p => p.name === currentCapture)) {
          captureProject.value = currentCapture;
        } else {
          captureProject.selectedIndex = 0;
        }

        const currentFilter = filterProject.value;
        filterProject.innerHTML = '<option value="">all projects</option>';
        for (const p of projects) {
          const opt = document.createElement("option");
          opt.value = p.name;
          opt.textContent = p.name;
          filterProject.appendChild(opt);
        }
        filterProject.value = currentFilter;
      }

      function renderProjectList() {
        if (projects.length === 0) {
          projectListEl.innerHTML = '<div style="color: var(--text-dim); font-size: 11px;">no projects registered</div>';
          return;
        }
        projectListEl.innerHTML = projects.map(p =>
          '<div class="project-item">' +
            '<span>' + esc(p.name) + '</span>' +
            '<button class="project-delete" data-project-id="' + p.id + '" title="delete">\u00d7</button>' +
          '</div>'
        ).join("");
      }

      scanBtn.addEventListener("click", async () => {
        const path = scanPathInput.value.trim();
        if (!path) return;

        scanStatus.textContent = "scanning\u2026";
        scanResults.style.display = "none";

        try {
          const res = await fetch("/api/projects/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path }),
          });
          const data = await res.json();

          if (!res.ok) {
            scanStatus.textContent = "error: " + (data.error || "scan failed");
            return;
          }

          if (data.candidates.length === 0) {
            scanStatus.textContent = "no GitHub repos found";
            return;
          }

          const existingNames = new Set(projects.map(p => p.name));
          const newCandidates = data.candidates.filter(c => !existingNames.has(c));

          if (newCandidates.length === 0) {
            scanStatus.textContent = "all " + data.candidates.length + " found repos are already registered";
            return;
          }

          scanCandidates.innerHTML = newCandidates.map(name =>
            '<label><input type="checkbox" value="' + esc(name) + '" checked /> ' + esc(name) + '</label>'
          ).join("");

          scanStatus.textContent = newCandidates.length + " new repo(s) found" +
            (data.candidates.length > newCandidates.length
              ? " (" + (data.candidates.length - newCandidates.length) + " already registered)"
              : "");
          scanResults.style.display = "block";
        } catch (err) {
          scanStatus.textContent = "error: could not connect";
        }
      });

      selectAllBtn.addEventListener("click", () => {
        scanCandidates.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = true;
        });
      });

      registerSelectedBtn.addEventListener("click", async () => {
        const checked = scanCandidates.querySelectorAll('input[type="checkbox"]:checked');
        const names = Array.from(checked).map(cb => cb.value);
        if (names.length === 0) return;

        try {
          const res = await fetch("/api/projects", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ names }),
          });

          if (res.ok) {
            scanResults.style.display = "none";
            scanStatus.textContent = names.length + " project(s) registered";
            await fetchProjects();
          }
        } catch (err) {
          scanStatus.textContent = "error registering projects";
        }
      });

      projectListEl.addEventListener("click", async (e) => {
        const btn = e.target.closest(".project-delete");
        if (!btn) return;
        const id = parseInt(btn.dataset.projectId, 10);

        try {
          await fetch("/api/projects/" + id, { method: "DELETE" });
          await fetchProjects();
        } catch (err) {
          console.error("Failed to delete project:", err);
        }
      });

      // Initial load
      fetchProjects().then(() => fetchObservations());
    })();
  </script>
</body>
</html>
